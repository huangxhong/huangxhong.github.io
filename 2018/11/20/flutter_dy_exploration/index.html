<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Flutter 模块动态化初探 · dim's blog</title><meta name="description" content="Flutter 模块动态化初探 - Dim"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://dim.red/atom.xml" title="dim's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Flutter 模块动态化初探</h1><div class="post-info">Nov 20, 2018</div><div class="post-content"><p><a href="http://dim.red">dim.red</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="https://flutter.io/" target="_blank" rel="noopener">Flutter</a> : Flutter allows you to build beautiful native apps on iOS and Android from a single codebase.  具有跨平台, 高性能的优势.<br><a id="more"></a></p>
<h1 id="Flutter-产物"><a href="#Flutter-产物" class="headerlink" title="Flutter 产物"></a>Flutter 产物</h1><p><img src="https://upload-images.jianshu.io/upload_images/166866-ec16bd55f1c1a303.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=" Flutter 产物"></p>
<p>产物流向:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/166866-5749c05ad706c7d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="产物流向"><br>通过分析我们可以发现<br>不变的产物有 flutter.jar ,libfluter.so,icudtl.dat, vm_snapshot_data , vm_snapshot_instr, 不跟业务代码相关, 只跟 flutter engine 的版本有关. </p>
<p>变化的产物: flutter_assets , isolate_snapshot_data , isolate_snapshot_instr 主要是业务的代码和资源.<br>LICENSE 没用, 可以删除.<br>总结:<br>我们通过将不变的产物集成到APK 中.将变化组成一个资源包,通过配置下发下来.</p>
<h1 id="动态化改造"><a href="#动态化改造" class="headerlink" title="动态化改造"></a>动态化改造</h1><h2 id="Flutter-SDK-改造"><a href="#Flutter-SDK-改造" class="headerlink" title="Flutter SDK 改造"></a>Flutter SDK 改造</h2><p>修改 <code>Flutter.createView()</code> 方法.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">  public static FlutterView createView(@NonNull final Context activity, @NonNull final Lifecycle lifecycle,</span><br><span class="line">                                       final String initialRoute, String bundlePath) &#123;</span><br><span class="line">      Context context = activity;</span><br><span class="line">      if (!TextUtils.isEmpty(bundlePath)) &#123;</span><br><span class="line">          final AssetManager bundleAsset = AssetManagerUtils.newAssetManager(bundlePath); //  Flutter  组件资源包位置</span><br><span class="line">          context = new ContextWrapper(activity) &#123;</span><br><span class="line">              @Override</span><br><span class="line">              public Resources getResources() &#123;</span><br><span class="line">                  return new Resources(bundleAsset,</span><br><span class="line">                          super.getResources().getDisplayMetrics(), super.getResources().getConfiguration()) &#123;</span><br><span class="line">                  &#125;;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FlutterMain.startInitialization(context); // 使用自定义的 context </span><br><span class="line">      FlutterMain.ensureInitializationComplete(activity.getApplicationContext(), null);</span><br><span class="line">      final FlutterNativeView nativeView = new FlutterNativeView(context);// 使用自定义的 context </span><br><span class="line">    ...</span><br><span class="line">      return flutterView;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里:  通过反射 AssetManger . 同时将 bundlePath 添加进去.<br>bundlePath 的作用:</p>
<ul>
<li>用于查找 flutter_assets,  bundleAsset  会在 <code>FlutterNativeView.nativeRunBundleAndSnapshotFromLibrary()</code>传递给 Flutter 用于查找 flutter_assets  资源.</li>
<li>用于 copy isolate_snapshot_data , isolate_snapshot_instr 资源.</li>
</ul>
<p>Copy 资源是由 ResourceExtractor 完成的.<br>我们需要修改 ResourceExtractor.ExtractTask<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">private void extractResources() &#123;</span><br><span class="line">         final File dataDir = new File(PathUtils.getDataDirectory(mContext));</span><br><span class="line">         final AssetManager bundleManger = mContext.getResources().getAssets();</span><br><span class="line">         //获取 Apk 自身的 AssetsManger</span><br><span class="line">         final AssetManager shareManager = mContext.getApplicationContext().getResources().getAssets();</span><br><span class="line">         final String fluterBundleVersion = getFluterBundleVersion(bundleManger);</span><br><span class="line">         if (fluterBundleVersion != null) &#123;</span><br><span class="line">             Log.i(TAG, &quot;delete cache fluterBundleVersion &quot; + fluterBundleVersion);</span><br><span class="line">             deleteFiles();</span><br><span class="line">         &#125;</span><br><span class="line">         AssetManager manager;</span><br><span class="line">         byte[] buffer = null;</span><br><span class="line">         for (String asset : mResources) &#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 final File output = new File(dataDir, asset);</span><br><span class="line"></span><br><span class="line">                 if (output.exists()) &#123;</span><br><span class="line">                     continue;</span><br><span class="line">                 &#125;</span><br><span class="line">                 if (output.getParentFile() != null) &#123;</span><br><span class="line">                     output.getParentFile().mkdirs();</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 manager = bundleManger;</span><br><span class="line">                 if (asset.startsWith(&quot;flutter_shared&quot;)</span><br><span class="line">                         || asset.equals(&quot;vm_snapshot_data&quot;)</span><br><span class="line">                         || asset.equals(&quot;vm_snapshot_instr&quot;)) &#123;</span><br><span class="line">                     manager = shareManager;</span><br><span class="line">                 &#125;</span><br><span class="line">                 ...</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; catch (FileNotFoundException fnfe) &#123;</span><br><span class="line"></span><br><span class="line">                 continue;</span><br><span class="line">             &#125; catch (IOException ioe) &#123;</span><br><span class="line">                 Log.w(TAG, &quot;Exception unpacking resources: &quot; + ioe.getMessage());</span><br><span class="line">                 deleteFiles();</span><br><span class="line">                 return;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (fluterBundleVersion != null) &#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 new File(dataDir, fluterBundleVersion).createNewFile();</span><br><span class="line">             &#125; catch (IOException e) &#123;</span><br><span class="line">                 Log.w(TAG, &quot;Failed to write resource timestamp&quot;);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     private String getFluterBundleVersion(AssetManager bundleAssets) &#123;</span><br><span class="line">         final File dataDir = new File(PathUtils.getDataDirectory(mContext));</span><br><span class="line">         String expectedTimestamp = null;</span><br><span class="line">         try &#123;</span><br><span class="line">             InputStream in = bundleAssets.open(&quot;flutter_bundle_version&quot;);</span><br><span class="line">             expectedTimestamp = VERSION_PREFIX + IoUtils.toString(in);</span><br><span class="line">         &#125; catch (IOException e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         if (expectedTimestamp == null) &#123;</span><br><span class="line">             return null;</span><br><span class="line">         &#125;</span><br><span class="line">         final String[] existingTimestamps = getVersionStamps(dataDir);</span><br><span class="line"></span><br><span class="line">         if (existingTimestamps == null) &#123;</span><br><span class="line">             return null;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (existingTimestamps.length != 1</span><br><span class="line">                 || !expectedTimestamp.equals(existingTimestamps[0])) &#123;</span><br><span class="line">             return expectedTimestamp;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         return null;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>
<p>主要的修改:</p>
<ul>
<li>共享的资源由 APK 的 AssetsManger 中获取. 其他由 bundleManger 中获取 </li>
<li>修改 ResourceExtractor 更新资源逻辑, 由本来的 res_timestamp- {versionCode} -{packageInfo.lastUpdateTime} 不同就更新改为 flutter_bundle_version 不同就更新.</li>
</ul>
<h2 id="打包插件修改"><a href="#打包插件修改" class="headerlink" title="打包插件修改:"></a>打包插件修改:</h2><h3 id="组件资源插件"><a href="#组件资源插件" class="headerlink" title="组件资源插件"></a>组件资源插件</h3><p><img src="https://upload-images.jianshu.io/upload_images/166866-699498d0e97ca513.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>需要做的事情:</p>
<ul>
<li>需要组合成一个APK, 因为需要被 AssetManger 识别.</li>
<li>不需要包含代码,</li>
<li>android 资源尽可能少, 但是需要 AndroidManifest.xml</li>
<li>flutter_bundle_version. 每次编译都应不同, 用于 ResourceExtractor 更新版本逻辑.</li>
<li>flutter_engine_version 获取 flutter sdk 版本, 相同版本才能升级, 防止因为版本实现不同导致的 bug.</li>
<li>flutter_bridge_version 是一个 md5. 是对所有自定义的  <code>MethodChannel.MethodCallHandler</code> 进行 ABI 格式化. 即 APK 具有一样的扩展能力.相同版本才能升级.</li>
<li>保留 isolate_snapshot_data, isolate_snapshot_instr 文件.<h3 id="lib-插件"><a href="#lib-插件" class="headerlink" title="lib 插件"></a>lib 插件</h3>Flutter 模块 一般情况我们是以 aar 的形式依赖. 需要修改上传到 maven 的AAR 如下.<br><img src="https://upload-images.jianshu.io/upload_images/166866-78ce6a0fdb15a568.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></li>
<li>保留 vm_snapshot_data, vm_snapshot_instr 文件.</li>
<li>保留 flutter_bundle_version ,flutter_engine_version,flutter_bridge_version 作用如上.</li>
</ul>
<h2 id="flutter-gradle-修改"><a href="#flutter-gradle-修改" class="headerlink" title="flutter.gradle 修改"></a>flutter.gradle 修改</h2><ul>
<li>copy  {flutter sdk}\flutter\packages\flutter_tools\gradle\flutter.gradle</li>
<li>修改 release  依赖为自定义的 flutter jar.</li>
</ul>
<h1 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h1><p>  更详情的分析留在后面。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/11/18/android_reference_exploration/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'dimredblog';
var disqus_identifier = '2018/11/20/flutter_dy_exploration/';
var disqus_title = 'Flutter 模块动态化初探';
var disqus_url = 'http://dim.red/2018/11/20/flutter_dy_exploration/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//dimredblog.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://dim.red">Dim</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>