<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 借助微信 构建 Android Project 编译通知 · dim's blog</title><meta name="description" content="借助微信 构建 Android Project 编译通知 - Dim"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/disqusjs.css"><link rel="search" type="application/opensearchdescription+xml" href="http://dim.red/atom.xml" title="dim's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">借助微信 构建 Android Project 编译通知</h1><div class="post-info">Dec 14, 2017</div><div class="post-content"><p><a href="http://dim.red">dim.red</a>  </p>
<h1 id="一-背景"><a href="#一-背景" class="headerlink" title="一 背景"></a>一 背景</h1><p> 最近萌生一个想法, 在项目编译成功的时候给自己发送一条微信.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/166866-cdd29a90b64b6e43.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="效果图.png"><br><a id="more"></a></p>
<h1 id="二-原理"><a href="#二-原理" class="headerlink" title="二 原理"></a>二 原理</h1><p>我们需要跟微信进行交互 , 为了达到这个效果 . 我们在 微信 App 内开启一个 Http 服务. 当项目编译完成以后发起一个 Http 请求.  Http 服务响应这个请求. 将获取的数据转发发送给自己 . </p>
<h1 id="三-实现"><a href="#三-实现" class="headerlink" title="三 实现"></a>三 实现</h1><h2 id="1-Http-服务"><a href="#1-Http-服务" class="headerlink" title="1 Http 服务."></a>1 Http 服务.</h2><p> 我们在 <strong><a href="https://github.com/TKkk-iOSer/WeChatPlugin-MacOS" target="_blank" rel="noopener">WeChatPlugin-MacOS</a></strong> 的基础上做扩展 . 同时使用第三方库 GCDWebServer 进行快速的搭建 Http服务 .</p>
<h3 id="1-1-添加-GCDWebServer-依赖"><a href="#1-1-添加-GCDWebServer-依赖" class="headerlink" title="1.1 添加 GCDWebServer 依赖"></a>1.1 添加 GCDWebServer 依赖</h3><p>将原有的 [WeChatPlugin-MacOS] 项目 转换成 cocoapods 管理 .<br>将 GCDWebServer 添加到 Podfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">platform :osx, &apos;10.10&apos;</span><br><span class="line">inhibit_all_warnings!</span><br><span class="line"></span><br><span class="line">target &apos;WeChatPlugin&apos; do</span><br><span class="line">  pod &apos;GCDWebServer&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-开启-Http-服务"><a href="#1-2-开启-Http-服务" class="headerlink" title="1.2 开启 Http 服务"></a>1.2 开启 Http 服务</h3><p>WeChatPlugin/sources/Category/WeChat+hook.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;GCDWebServer/GCDWebServer.h&gt;</span><br><span class="line">#import &lt;GCDWebServer/GCDWebServerDataResponse.h&gt;</span><br></pre></td></tr></table></figure></p>
<p>WeChatPlugin/sources/Category/WeChat+hook.m<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static GCDWebServer *server;</span><br><span class="line">+ (void)setup &#123;</span><br><span class="line">   </span><br><span class="line">    server = [[GCDWebServer alloc] init];       </span><br><span class="line">    [server addHandlerForMethod:@&quot;GET&quot; path:@&quot;/wechat/notify&quot; requestClass:[GCDWebServerRequest class] processBlock:^GCDWebServerResponse * _Nullable(__kindof GCDWebServerRequest * _Nonnull request) &#123;</span><br><span class="line">        NSString *msg = [request.query[@&quot;msg&quot;] lowercaseString] ? : @&quot;&quot;;</span><br><span class="line">        NSString *currentUserName = [objc_getClass(&quot;CUtility&quot;) GetCurrentUserName];</span><br><span class="line">        MessageService *service = [[objc_getClass(&quot;MMServiceCenter&quot;) defaultCenter] getService:objc_getClass(&quot;MessageService&quot;)];</span><br><span class="line">        [service SendTextMessage:currentUserName toUsrName:currentUserName msgText:msg atUserList:nil];</span><br><span class="line">        return [GCDWebServerDataResponse responseWithJSONObject:@&#123;@&quot;success&quot;:@&quot;true&quot;&#125;];</span><br><span class="line">    &#125;];</span><br><span class="line"> </span><br><span class="line">    [server startWithOptions:@&#123;GCDWebServerOption_Port: @(9090),</span><br><span class="line">                                    GCDWebServerOption_BindToLocalhost: @(YES)&#125; error:nil];</span><br><span class="line">    ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-发送-Http-请求"><a href="#2-发送-Http-请求" class="headerlink" title="2 发送 Http 请求"></a>2 发送 Http 请求</h2><h3 id="2-1-设置监听器"><a href="#2-1-设置监听器" class="headerlink" title="2.1 设置监听器"></a>2.1 设置监听器</h3><p>在 <code>/Users/{username}/.gradle</code> 下建立一个文件 <code>init.gradle</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line"></span><br><span class="line">    if (project.getProperties().get(&quot;notiy&quot;, false)) &#123;</span><br><span class="line">        project.pluginManager.withPlugin(&quot;com.android.application&quot;, &#123;</span><br><span class="line">            def pj = project;</span><br><span class="line">            def projectName = project.rootProject.name + &quot;:&quot; + pj.name;</span><br><span class="line">            def clock = new org.gradle.internal.time.Clock()</span><br><span class="line">            pj.getGradle().addBuildListener(new BuildListener() &#123;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                void buildStarted(Gradle gradle) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                void settingsEvaluated(Settings settings) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                void projectsLoaded(Gradle gradle) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                void projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                void buildFinished(BuildResult result) &#123;</span><br><span class="line"></span><br><span class="line">                    boolean isAssembleTask = false</span><br><span class="line">                    pj.android.applicationVariants.each &#123; variant -&gt;</span><br><span class="line">                        if (variant.getAssemble().state.executed) &#123;</span><br><span class="line">                            isAssembleTask = true</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    def sp = pj.gradle.startParameter</span><br><span class="line">                    def t = sp.taskNames[0] as String</span><br><span class="line"></span><br><span class="line">                    NameMatcher nameMatcher = new NameMatcher()</span><br><span class="line">                    def taskName = nameMatcher.find(t, pj.tasks.asMap.keySet());</span><br><span class="line">                    taskName = taskName == null ? t : taskName;</span><br><span class="line"></span><br><span class="line">                    if (isAssembleTask || (result.failure != null &amp;&amp; (taskName.startsWith(&quot;assemble&quot;) || taskName.startsWith(&quot;install&quot;)))) &#123;</span><br><span class="line">                        String msg;</span><br><span class="line">                        if (result.failure == null) &#123;</span><br><span class="line">                            msg = &quot;项目 : $&#123;projectName&#125; \n任务 : $&#123;taskName&#125; \n编译 : 成功\n&quot; +</span><br><span class="line">                                    &quot;耗时 : $&#123;clock.elapsed&#125;&quot;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            msg = &quot;项目 : $&#123;projectName&#125; \n任务 : $&#123;taskName&#125; \n编译 : 失败\n&quot; +</span><br><span class="line">                                    &quot;错误 : $&#123;result.failure.getMessage()&#125;\n&quot; +</span><br><span class="line">                                    &quot;耗时 : $&#123;clock.elapsed&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        (&quot;curl -X GET   http://localhost:9090/wechat/notify?msg=&quot; +</span><br><span class="line">                                URLEncoder.encode(msg, &quot;UTF-8&quot;)).execute()</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里在 gradle init 的时候加入监听 , 监听所有 android 项目的编译 ,  判断编译命令中是否包含参数 notiy , 并且 notity 为 true , 如果判断成功当编译完成 , 使用 curl 将编译结果发送 Http 服务 .  </p>
<h3 id="2-2-命令行使用"><a href="#2-2-命令行使用" class="headerlink" title="2.2 命令行使用"></a>2.2 命令行使用</h3><p>在原有的编译命令添加额外参数 <code>-P notiy=true</code><br>eg:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assembleDebug -P notiy=true</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-优化"><a href="#2-3-优化" class="headerlink" title="2.3 优化"></a>2.3 优化</h3><p>为了优化体验.我们可以将参数设置成默认.<br>因为 Android 项目的编译触发有两种方式: 命令行 和 idea . 这里的优化也分为两种情况,<br>情况一 : 命令行<br>修改 gradlew 文件末端 , 添加 <code>&quot;-P&quot; &quot;notiy=true&quot;</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec &quot;$JAVACMD&quot; &quot;$&#123;JVM_OPTS[@]&#125;&quot; -classpath &quot;$CLASSPATH&quot; org.gradle.wrapper.GradleWrapperMain &quot;$@&quot; &quot;-P&quot; &quot;notiy=true&quot;</span><br></pre></td></tr></table></figure></p>
<p>情况二 : Idea<br>配置添加 <code>-P notiy=true</code><br><img src="http://upload-images.jianshu.io/upload_images/166866-cefbcf8ca5ccc88d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/12/16/inovel_dynamic_proxy/" class="prev">PREV</a><a href="/2017/12/04/aop/" class="next">NEXT</a></div><div id="disqus_thread"></div><script src="/disqus.js"></script><script>var dsqjs = new DisqusJS({
shortname: 'dimredblog', 
identifier: '2017/12/14/wechat_notify_system/',
url: 'http://dim.red/2017/12/14/wechat_notify_system/', 
api: 'https://disqus.skk.moe/disqus/', 
apikey: 'MvtREFDD6pEIlmM1eqv3vACcJYJSAXfmfgYO4tlVfvgqlPSeE4xhPLQE0YXAbBBe'
});</script><div class="copyright"><p>© 2015 - 2019 <a href="http://dim.red">Dim</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>